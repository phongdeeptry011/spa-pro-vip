<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Spa Pro Manager ‚Äî Demo</title>

<!-- Google font + material icons -->
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

<style>
:root{
  --bg:#f6f7fb; --card:#ffffff; --accent:#6a4ab4; --accent2:#b27cf0;
  --muted:#6b7280; --success:#10b981; --danger:#ef4444; --radius:12px;
}
*{box-sizing:border-box}
body{margin:0;font-family:Roboto,system-ui,-apple-system,Segoe UI,Arial;background:var(--bg);color:#0f172a}
.app{display:flex;min-height:100vh}
.sidebar{
  width:250px;background:linear-gradient(180deg,var(--accent),var(--accent2));color:#fff;padding:20px;display:flex;flex-direction:column;
  gap:12px;box-shadow:6px 0 20px rgba(0,0,0,0.08)
}
.brand{display:flex;align-items:center;gap:12px}
.logo{width:48px;height:48px;border-radius:10px;background:rgba(255,255,255,0.12);display:flex;align-items:center;justify-content:center;font-weight:700}
.brand .title{font-size:17px;font-weight:700}
.sidebar .desc{font-size:12px;opacity:0.9}
.nav{margin-top:8px;display:flex;flex-direction:column;gap:6px}
.nav button{
  background:transparent;border:none;color:#fff;text-align:left;padding:10px;border-radius:10px;cursor:pointer;font-weight:500;display:flex;gap:10px;align-items:center
}
.nav button:hover{background:rgba(255,255,255,0.06)}
.nav button.active{background:rgba(255,255,255,0.12);box-shadow:inset 0 0 0 1px rgba(255,255,255,0.04)}
.sidebar .bottom{margin-top:auto;display:flex;flex-direction:column;gap:8px;font-size:13px}

.main{flex:1;padding:18px 22px;overflow:auto}
.header{display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:12px}
.header .search{background:var(--card);padding:8px 12px;border-radius:10px;display:flex;gap:8px;align-items:center;box-shadow:0 6px 20px rgba(2,6,23,0.04)}
.header input{border:0;outline:none;font-size:14px}

.card{background:var(--card);border-radius:12px;padding:14px;box-shadow:0 6px 24px rgba(2,6,23,0.06);margin-bottom:12px}
.grid{display:grid;gap:12px}
.g-3{grid-template-columns:repeat(3,1fr)}
.g-2{grid-template-columns:repeat(2,1fr)}
.kpi{display:flex;gap:12px}
.kpi .item{flex:1;background:linear-gradient(180deg,#fff,#fbfbff);padding:12px;border-radius:10px}

.table-wrap{overflow:auto}
table{width:100%;border-collapse:collapse}
th,td{padding:10px;border-bottom:1px solid #f1f5f9;text-align:left;font-size:14px}
thead th{color:var(--muted);font-weight:700}

.btn{padding:8px 12px;border-radius:10px;border:none;cursor:pointer;font-weight:600}
.btn.primary{background:linear-gradient(90deg,var(--accent),var(--accent2));color:#fff}
.btn.ghost{background:transparent;border:1px solid #eef1fa;color:var(--muted)}
.btn.warn{background:var(--accent2);color:#fff}
.btn.danger{background:var(--danger);color:#fff}
.small{padding:6px 8px;font-size:13px;border-radius:8px}

/* modal */
.modal-backdrop{position:fixed;inset:0;background:rgba(2,6,23,0.4);display:none;align-items:center;justify-content:center;z-index:2000}
.modal{width:720px;max-width:96%;background:var(--card);padding:16px;border-radius:12px}
.modal h3{margin:0 0 8px 0}
.row{display:flex;gap:10px;margin-bottom:10px}
.col{flex:1}
.label{font-size:13px;color:var(--muted);margin-bottom:6px;display:block}
.input,select,textarea{width:100%;padding:8px;border-radius:8px;border:1px solid #e6e9ef;font-size:14px}
textarea{min-height:80px}

/* login page full screen */
.login-screen{min-height:100vh;display:flex;align-items:center;justify-content:center;background:linear-gradient(180deg,#faf8ff,#f3f4f9)}
.login-box{width:420px;background:var(--card);padding:20px;border-radius:12px;box-shadow:0 10px 40px rgba(2,6,23,0.08)}

/* small */
.muted{color:var(--muted)}
.tiny{font-size:12px;color:var(--muted)}
.right{text-align:right}

/* responsive */
@media(max-width:980px){
  .sidebar{display:none}
  .main{padding:12px}
  .g-3,.g-2{grid-template-columns:1fr}
}
</style>
</head>
<body>

<!-- LOGIN / REGISTER (shown when no session) -->
<div id="loginView" class="login-screen" style="display:none">
  <div class="login-box">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div>
        <div style="font-size:20px;font-weight:700">Spa Pro Manager</div>
        <div class="tiny muted">ƒêƒÉng nh·∫≠p ƒë·ªÉ v√†o h·ªá th·ªëng (demo offline)</div>
      </div>
      <div class="logo" style="width:44px;height:44px;border-radius:8px">SP</div>
    </div>

    <div style="margin-top:14px">
      <div id="loginForm">
        <label class="label">T√™n ƒëƒÉng nh·∫≠p</label>
        <input id="loginUser" class="input" placeholder="username">
        <label class="label">M·∫≠t kh·∫©u</label>
        <input id="loginPass" type="password" class="input" placeholder="password">
        <div style="display:flex;gap:8px;margin-top:12px">
          <button class="btn primary" onclick="doLogin()">ƒêƒÉng nh·∫≠p</button>
          <button class="btn ghost" onclick="showRegister()">ƒêƒÉng k√Ω</button>
        </div>
        <div class="tiny muted" style="margin-top:10px">M·∫∑c ƒë·ªãnh: <strong>admin/admin123</strong> (Admin) ‚Äî <strong>tech1/tech123</strong> (KTV)</div>
      </div>

      <div id="regForm" style="display:none">
        <label class="label">T√™n ƒëƒÉng nh·∫≠p</label>
        <input id="regUserInput" class="input" placeholder="username">
        <label class="label">M·∫≠t kh·∫©u</label>
        <input id="regPassInput" type="password" class="input" placeholder="password">
        <label class="label">Vai tr√≤</label>
        <select id="regRoleSelect" class="input"><option value="tech">K·ªπ thu·∫≠t vi√™n</option><option value="admin">Admin</option></select>
        <div style="display:flex;gap:8px;margin-top:12px">
          <button class="btn primary" onclick="doRegister()">ƒêƒÉng k√Ω</button>
          <button class="btn ghost" onclick="showLogin()">Tr·ªü l·∫°i</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- APP -->
<div id="app" class="app" style="display:none">

  <!-- SIDEBAR -->
  <aside class="sidebar" role="navigation">
    <div class="brand">
      <div class="logo">SP</div>
      <div>
        <div class="title">Spa Pro Manager</div>
        <div class="desc tiny">Qu·∫£n l√Ω tour/ca ‚Äî demo offline</div>
      </div>
    </div>

    <nav class="nav" id="menu">
      <button class="active" data-view="dashboard" onclick="switchView(event)"> <span class="material-icons">dashboard</span> Dashboard</button>
      <button data-view="bookings" onclick="switchView(event)"> <span class="material-icons">event</span> L·ªãch h·∫πn</button>
      <button data-view="customers" onclick="switchView(event)"> <span class="material-icons">people</span> Kh√°ch h√†ng</button>
      <button data-view="services" onclick="switchView(event)"> <span class="material-icons">spa</span> D·ªãch v·ª•</button>
      <button data-view="techs" onclick="switchView(event)"> <span class="material-icons">person</span> K·ªπ thu·∫≠t vi√™n</button>
      <button data-view="revenue" onclick="switchView(event)"> <span class="material-icons">attach_money</span> Doanh thu</button>
      <button data-view="settings" onclick="switchView(event)"> <span class="material-icons">settings</span> C√†i ƒë·∫∑t</button>
    </nav>

    <div class="bottom">
      <div class="tiny">Phi√™n b·∫£n: Demo 1.0</div>
      <div style="display:flex;gap:8px;margin-top:8px">
        <button class="btn ghost small" onclick="backup()">Sao l∆∞u</button>
        <label class="btn ghost small" style="cursor:pointer">Ph·ª•c h·ªìi <input id="fileRestore" type="file" accept="application/json" style="display:none" /></label>
      </div>
      <div style="display:flex;gap:8px;margin-top:8px">
        <button class="btn ghost small" onclick="logout()">ƒêƒÉng xu·∫•t</button>
        <button class="btn ghost small" id="themeBtn" onclick="toggleTheme()">üåì</button>
      </div>
    </div>
  </aside>

  <!-- MAIN -->
  <main class="main">

    <div class="header">
      <div style="display:flex;gap:12px;align-items:center">
        <div class="search">
          <span class="material-icons" style="color:var(--accent)">search</span>
          <input id="globalSearch" placeholder="T√¨m t√™n, SƒêT, d·ªãch v·ª•..." oninput="doGlobalSearch(this.value)" />
        </div>
        <div class="tiny muted">Xin ch√†o, <strong id="userLabel">-</strong></div>
      </div>
      <div class="right tiny muted" id="roleLabel">‚Äî</div>
    </div>

    <!-- VIEWS: each is hidden by default except dashboard -->
    <!-- Dashboard -->
    <section id="view_dashboard" class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h2>Dashboard</h2>
        <div class="tiny muted">D·ªØ li·ªáu m·∫´u ƒë∆∞·ª£c n·∫°p s·∫µn</div>
      </div>

      <div class="grid g-3" style="margin-top:12px">
        <div class="card kpi">
          <div class="item">
            <div class="tiny muted">T·ªïng kh√°ch h√†ng</div>
            <div id="kpi_customers" style="font-weight:700;font-size:20px">0</div>
          </div>
          <div class="item">
            <div class="tiny muted">D·ªãch v·ª•</div>
            <div id="kpi_services" style="font-weight:700;font-size:20px">0</div>
          </div>
          <div class="item">
            <div class="tiny muted">K·ªπ thu·∫≠t vi√™n</div>
            <div id="kpi_techs" style="font-weight:700;font-size:20px">0</div>
          </div>
        </div>

        <div class="card">
          <h3>T·ªïng quan l·ªãch h√¥m nay</h3>
          <div id="todayBookings" class="tiny muted">Kh√¥ng c√≥ l·ªãch h√¥m nay</div>
        </div>

        <div class="card">
          <h3>Ph√≠m nhanh</h3>
          <div style="display:flex;gap:8px">
            <button class="btn primary" onclick="showAddBooking()">+ T·∫°o l·ªãch</button>
            <button class="btn ghost" onclick="showAddCustomer()">+ Th√™m KH</button>
            <button class="btn ghost" onclick="showAddService()">+ Th√™m DV</button>
          </div>
        </div>
      </div>
    </section>

    <!-- Bookings -->
    <section id="view_bookings" class="card" style="display:none">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h2>L·ªãch h·∫πn</h2>
        <div style="display:flex;gap:8px;align-items:center">
          <input type="date" id="bookFilterDate" class="input tiny" onchange="renderBookings()" />
          <select id="bookFilterTech" class="input tiny" onchange="renderBookings()"><option value="all">T·∫•t c·∫£ KTV</option></select>
          <button class="btn primary" onclick="showAddBooking()">+ T·∫°o l·ªãch</button>
          <button class="btn ghost" onclick="exportBookings()">Xu·∫•t CSV</button>
        </div>
      </div>

      <div class="table-wrap" style="margin-top:12px">
        <table>
          <thead><tr><th>Ng√†y</th><th>Gi·ªù</th><th>Kh√°ch</th><th>SƒêT</th><th>D·ªãch v·ª•</th><th>KTV</th><th>Gi√°</th><th>Tr·∫°ng th√°i</th><th>H√†nh ƒë·ªông</th></tr></thead>
          <tbody id="tb_bookings"><tr><td colspan="9" class="muted tiny">Kh√¥ng c√≥ l·ªãch</td></tr></tbody>
        </table>
      </div>
    </section>

    <!-- Customers -->
    <section id="view_customers" class="card" style="display:none">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h2>Kh√°ch h√†ng</h2>
        <div style="display:flex;gap:8px;align-items:center">
          <input id="cust_q" class="input tiny" placeholder="T√¨m kh√°ch..." oninput="renderCustomers()" />
          <button class="btn primary" onclick="showAddCustomer()">+ Th√™m kh√°ch</button>
          <button class="btn ghost" onclick="exportCustomers()">Xu·∫•t CSV</button>
        </div>
      </div>

      <div class="table-wrap" style="margin-top:12px">
        <table>
          <thead><tr><th>T√™n</th><th>SƒêT</th><th>L·∫ßn ƒë·∫øn</th><th>Ghi ch√∫</th><th>H√†nh ƒë·ªông</th></tr></thead>
          <tbody id="tb_customers"><tr><td colspan="5" class="muted tiny">Ch∆∞a c√≥</td></tr></tbody>
        </table>
      </div>
    </section>

    <!-- Services -->
    <section id="view_services" class="card" style="display:none">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h2>D·ªãch v·ª•</h2>
        <div style="display:flex;gap:8px;align-items:center">
          <input id="svc_q" class="input tiny" placeholder="T√¨m d·ªãch v·ª•..." oninput="renderServices()" />
          <button class="btn primary" onclick="showAddService()">+ Th√™m d·ªãch v·ª•</button>
          <button class="btn ghost" onclick="exportServices()">Xu·∫•t CSV</button>
        </div>
      </div>

      <div class="table-wrap" style="margin-top:12px">
        <table>
          <thead><tr><th>T√™n d·ªãch v·ª•</th><th>Gi√° (‚Ç´)</th><th>Th·ªùi l∆∞·ª£ng (ph√∫t)</th><th>H√†nh ƒë·ªông</th></tr></thead>
          <tbody id="tb_services"><tr><td colspan="4" class="muted tiny">Ch∆∞a c√≥</td></tr></tbody>
        </table>
      </div>
    </section>

    <!-- Techs -->
    <section id="view_techs" class="card" style="display:none">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h2>K·ªπ thu·∫≠t vi√™n</h2>
        <div style="display:flex;gap:8px;align-items:center">
          <input id="tech_q" class="input tiny" placeholder="T√¨m KTV..." oninput="renderTechs()" />
          <button class="btn primary" onclick="showAddTech()">+ Th√™m KTV</button>
          <button class="btn ghost" onclick="exportTechs()">Xu·∫•t CSV</button>
        </div>
      </div>

      <div class="table-wrap" style="margin-top:12px">
        <table>
          <thead><tr><th>T√™n</th><th>Phone</th><th>% Hoa h·ªìng</th><th>Tr·∫°ng th√°i</th><th>H√†nh ƒë·ªông</th></tr></thead>
          <tbody id="tb_techs"><tr><td colspan="5" class="muted tiny">Ch∆∞a c√≥</td></tr></tbody>
        </table>
      </div>
    </section>

    <!-- Revenue -->
    <section id="view_revenue" class="card" style="display:none">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h2>Doanh thu & Hoa h·ªìng</h2>
        <div style="display:flex;gap:8px;align-items:center">
          <input type="month" id="rev_month" class="input tiny" />
          <button class="btn ghost" onclick="renderRevenue()">L·∫•y b√°o c√°o</button>
          <button class="btn ghost" onclick="exportRevenue()">Xu·∫•t CSV</button>
        </div>
      </div>
      <div style="margin-top:12px">
        <div id="rev_table" class="table-wrap"></div>
      </div>
    </section>

    <!-- Settings -->
    <section id="view_settings" class="card" style="display:none">
      <h2>C√†i ƒë·∫∑t</h2>
      <div class="grid g-2" style="margin-top:12px">
        <div class="card">
          <label class="label">T√™n Spa</label>
          <input id="spa_name" class="input" />
          <label class="label">% hoa h·ªìng m·∫∑c ƒë·ªãnh</label>
          <input id="spa_comm" type="number" class="input" min="0" max="100" />
          <div style="margin-top:10px;display:flex;gap:8px">
            <button class="btn primary" onclick="saveSettings()">L∆∞u</button>
            <button class="btn danger" onclick="resetData()">X√≥a to√†n b·ªô (v·ªÅ m·∫∑c ƒë·ªãnh)</button>
          </div>
        </div>

        <div class="card">
          <h3>Qu·∫£n l√Ω t√†i kho·∫£n</h3>
          <label class="label">ƒêƒÉng k√Ω user m·ªõi</label>
          <input id="new_user" class="input" placeholder="username" />
          <input id="new_pass" type="password" class="input" placeholder="password" />
          <select id="new_role" class="input">
            <option value="tech">K·ªπ thu·∫≠t vi√™n</option>
            <option value="admin">Admin</option>
          </select>
          <div style="margin-top:8px"><button class="btn primary" onclick="registerUser()">ƒêƒÉng k√Ω</button></div>
        </div>
      </div>
    </section>

  </main>
</div>

<!-- MODAL BACKDROP -->
<div id="modalBackdrop" class="modal-backdrop">
  <div class="modal" id="modalInner"></div>
</div>

<script>
/* ---------------------------
  Single-file Spa Pro Manager
  - Demo offline: saves to localStorage
  - Basic auth: local users (base64 password)
---------------------------- */

const LS_KEY = 'SPA_PRO_DEMO_V1';
const SESSION_KEY = 'SPA_PRO_SESSION_V1';

/* Default sample data */
const DEFAULT = {
  store:{name:'Spa Pro', defaultCommission:32},
  users:[
    {id:uid(), username:'admin', password:btoa('admin123'), role:'admin', name:'Admin'},
    {id:uid(), username:'tech1', password:btoa('tech123'), role:'tech', name:'KTV Lan'}
  ],
  customers:[
    {id:uid(), name:'Ch·ªã H∆∞∆°ng', phone:'0901234567', visits:2, note:'Da nh·∫°y c·∫£m'}
  ],
  services:[
    {id:uid(), name:"Massage Body 60'", price:400000, duration:60},
    {id:uid(), name:"Facial 45'", price:350000, duration:45},
    {id:uid(), name:"Foot 30'", price:200000, duration:30}
  ],
  techs:[
    {id:uid(), name:'Lan', phone:'0901999888', rate:35, active:true},
    {id:uid(), name:'H√†', phone:'0988555666', rate:30, active:true}
  ],
  bookings: [
    // sample: none initially
  ],
  createdAt: new Date().toISOString()
};

let state = loadState();
let session = loadSession();

/* ---------- init UI references ---------- */
const loginView = document.getElementById('loginView');
const appView = document.getElementById('app');
const userLabel = document.getElementById('userLabel');
const roleLabel = document.getElementById('roleLabel');
const menuButtons = document.querySelectorAll('.nav button');

/* ---------- util ---------- */
function uid(){ return 'id_'+Math.random().toString(36).slice(2,9)+Date.now().toString(36).slice(4); }
function fmtMoney(n){ return new Intl.NumberFormat('vi-VN',{style:'currency',currency:'VND',maximumFractionDigits:0}).format(n||0); }
function today(){ const d=new Date(); const tz=d.getTimezoneOffset(); const l=new Date(d.getTime()-tz*60000); return l.toISOString().slice(0,10); }
function timeToMin(hm){ if(!hm) return 0; const [h,m]=hm.split(':').map(Number); return h*60+m; }

/* ---------- storage ---------- */
function loadState(){
  try{
    const raw = localStorage.getItem(LS_KEY);
    if(!raw){ localStorage.setItem(LS_KEY, JSON.stringify(DEFAULT)); return JSON.parse(JSON.stringify(DEFAULT)); }
    return JSON.parse(raw);
  }catch(e){ localStorage.setItem(LS_KEY, JSON.stringify(DEFAULT)); return JSON.parse(JSON.stringify(DEFAULT)); }
}
function saveState(){ localStorage.setItem(LS_KEY, JSON.stringify(state)); }
function loadSession(){ try{ const s=localStorage.getItem(SESSION_KEY); return s?JSON.parse(s):null;}catch(e){return null;} }
function saveSession(){ localStorage.setItem(SESSION_KEY, JSON.stringify(session)); }
function clearSession(){ localStorage.removeItem(SESSION_KEY); session=null; }

/* ---------- auth ---------- */
function showRegister(){ document.getElementById('loginForm').style.display='none'; document.getElementById('regForm').style.display='block'; }
function showLogin(){ document.getElementById('loginForm').style.display='block'; document.getElementById('regForm').style.display='none'; }
function doRegister(){
  const u = document.getElementById('regUserInput').value.trim();
  const p = document.getElementById('regPassInput').value;
  const role = document.getElementById('regRoleSelect').value;
  if(!u||!p) return alert('Nh·∫≠p username & password');
  if(state.users.some(x=>x.username===u)) return alert('Username ƒë√£ t·ªìn t·∫°i');
  state.users.push({id:uid(), username:u, password:btoa(p), role, name:u});
  saveState();
  alert('ƒêƒÉng k√Ω th√†nh c√¥ng. Vui l√≤ng ƒëƒÉng nh·∫≠p.');
  showLogin();
}
function doLogin(){
  const u = document.getElementById('loginUser').value.trim();
  const p = document.getElementById('loginPass').value;
  if(!u||!p) return alert('Nh·∫≠p username & password');
  const found = state.users.find(x=>x.username===u && x.password===btoa(p));
  if(!found) return alert('Sai th√¥ng tin ƒëƒÉng nh·∫≠p');
  session = {userId:found.id, username:found.username, role:found.role, name:found.name||found.username};
  saveSession();
  enterApp();
}
function logout(){ if(confirm('ƒêƒÉng xu·∫•t?')){ clearSession(); location.reload(); } }

/* ---------- init / enter ---------- */
function enterApp(){
  loginView.style.display='none'; appView.style.display='flex';
  userLabel.textContent = session.name || session.username;
  roleLabel.textContent = session.role==='admin' ? 'Admin' : 'K·ªπ thu·∫≠t vi√™n';
  // role control: hide admin-only screens for tech
  if(session.role==='tech'){
    document.querySelector('[data-view="services"]').style.display='none';
    document.querySelector('[data-view="techs"]').style.display='none';
    document.querySelector('[data-view="settings"]').style.display='none';
    document.querySelector('[data-view="revenue"]').style.display='none';
  }
  // default view
  activateMenu('dashboard');
  renderAll();
}

/* ---------- UI switching ---------- */
function switchView(e){
  const btn = (e.currentTarget);
  const view = btn.dataset.view;
  activateMenuBtn(btn);
  showView(view);
}
function activateMenuBtn(btn){
  menuButtons.forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
}
function activateMenu(view){
  const btn = Array.from(menuButtons).find(b=>b.dataset.view===view);
  if(btn) activateMenuBtn(btn);
  showView(view);
}
function showView(view){
  // hide all view sections
  const sections = document.querySelectorAll('main section');
  sections.forEach(s=>s.style.display='none');
  const id = 'view_'+view;
  const el = document.getElementById(id);
  if(el) el.style.display='block';
  // render as needed
  if(view==='dashboard') renderDashboard();
  if(view==='bookings') renderBookings();
  if(view==='customers') renderCustomers();
  if(view==='services') renderServices();
  if(view==='techs') renderTechs();
  if(view==='revenue') renderRevenue();
  if(view==='settings') renderSettings();
}

/* ---------- rendering ---------- */
function renderAll(){
  renderDashboard(); renderBookings(); renderCustomers(); renderServices(); renderTechs(); renderRevenue(); renderSettings();
}
function renderDashboard(){
  document.getElementById('kpi_customers').textContent = state.customers.length;
  document.getElementById('kpi_services').textContent = state.services.length;
  document.getElementById('kpi_techs').textContent = state.techs.length;
  // today bookings
  const d = today();
  const list = state.bookings.filter(b=>b.date===d).sort((a,b)=>a.time.localeCompare(b.time));
  const tdiv = document.getElementById('todayBookings');
  if(!list.length) tdiv.innerHTML = '<div class="tiny muted">Kh√¥ng c√≥ l·ªãch h√¥m nay</div>';
  else tdiv.innerHTML = list.map(b=> {
    const svc = state.services.find(s=>s.id===b.serviceId); const tech = state.techs.find(t=>t.id===b.techId);
    return `<div style="margin-bottom:6px"><strong>${b.time}</strong> ‚Äî ${escapeHtml(b.customerName)} ‚Ä¢ ${escapeHtml(svc?svc.name:'')} ‚Ä¢ ${escapeHtml(tech?tech.name:'')} <span class="tiny muted">[${b.status}]</span></div>`;
  }).join('');
}

function renderBookings(){
  const dateEl = document.getElementById('bookFilterDate');
  if(!dateEl.value) dateEl.value = today();
  const date = dateEl.value;
  // populate tech filter
  const techSel = document.getElementById('bookFilterTech'); techSel.innerHTML = '<option value="all">T·∫•t c·∫£ KTV</option>';
  state.techs.forEach(t=> techSel.insertAdjacentHTML('beforeend', `<option value="${t.id}">${escapeHtml(t.name)}</option>`));
  // rows
  const tbody = document.getElementById('tb_bookings');
  const list = state.bookings.filter(b => b.date===date);
  if(!list.length){ tbody.innerHTML = '<tr><td colspan="9" class="muted tiny">Kh√¥ng c√≥ l·ªãch</td></tr>'; return; }
  tbody.innerHTML = list.sort((a,b)=>a.time.localeCompare(b.time)).map(b=>{
    const svc = state.services.find(s=>s.id===b.serviceId); const tech = state.techs.find(t=>t.id===b.techId);
    return `<tr>
      <td>${b.date}</td>
      <td>${b.time}</td>
      <td>${escapeHtml(b.customerName)}</td>
      <td>${escapeHtml(b.phone)}</td>
      <td>${escapeHtml(svc?svc.name:'')}</td>
      <td>${escapeHtml(tech?tech.name:'')}</td>
      <td>${svc?fmtMoney(svc.price):'-'}</td>
      <td>${escapeHtml(b.status)}</td>
      <td>
        <button class="btn small" onclick="editBooking('${b.id}')">S·ª≠a</button>
        <button class="btn small primary" onclick="completeBooking('${b.id}')">Ho√†n th√†nh</button>
        <button class="btn small danger" onclick="deleteBooking('${b.id}')">X√≥a</button>
      </td>
    </tr>`;
  }).join('');
}

function renderCustomers(){
  const q = (document.getElementById('cust_q').value||'').toLowerCase();
  const tbody = document.getElementById('tb_customers');
  const list = state.customers.filter(c=> (c.name||'').toLowerCase().includes(q) || (c.phone||'').includes(q));
  if(!list.length) { tbody.innerHTML = '<tr><td colspan="5" class="muted tiny">Ch∆∞a c√≥</td></tr>'; return; }
  tbody.innerHTML = list.map(c=>`<tr>
    <td>${escapeHtml(c.name)}</td>
    <td>${escapeHtml(c.phone)}</td>
    <td>${c.visits||0}</td>
    <td>${escapeHtml(c.note||'')}</td>
    <td>
      <button class="btn small" onclick="editCustomer('${c.id}')">S·ª≠a</button>
      <button class="btn small danger" onclick="deleteCustomer('${c.id}')">X√≥a</button>
    </td>
  </tr>`).join('');
}

function renderServices(){
  const q = (document.getElementById('svc_q').value||'').toLowerCase();
  const tbody = document.getElementById('tb_services');
  const list = state.services.filter(s=> (s.name||'').toLowerCase().includes(q));
  if(!list.length){ tbody.innerHTML = '<tr><td colspan="4" class="muted tiny">Ch∆∞a c√≥</td></tr>'; return; }
  tbody.innerHTML = list.map(s=>`<tr>
    <td>${escapeHtml(s.name)}</td><td>${fmtMoney(s.price)}</td><td>${s.duration}</td>
    <td>
      <button class="btn small" onclick="editService('${s.id}')">S·ª≠a</button>
      <button class="btn small danger" onclick="deleteService('${s.id}')">X√≥a</button>
    </td>
  </tr>`).join('');
}

function renderTechs(){
  const q = (document.getElementById('tech_q').value||'').toLowerCase();
  const tbody = document.getElementById('tb_techs');
  const list = state.techs.filter(t=> (t.name||'').toLowerCase().includes(q) || (t.phone||'').includes(q));
  if(!list.length){ tbody.innerHTML = '<tr><td colspan="5" class="muted tiny">Ch∆∞a c√≥</td></tr>'; return; }
  tbody.innerHTML = list.map(t=>`<tr>
    <td>${escapeHtml(t.name)}</td><td>${escapeHtml(t.phone)}</td><td>${t.rate}%</td><td>${t.active?'ƒêang l√†m':'T·∫°m ngh·ªâ'}</td>
    <td>
      <button class="btn small" onclick="editTech('${t.id}')">S·ª≠a</button>
      <button class="btn small danger" onclick="deleteTech('${t.id}')">X√≥a</button>
    </td>
  </tr>`).join('');
}

function renderRevenue(){
  const month = document.getElementById('rev_month').value || (new Date()).toISOString().slice(0,7);
  document.getElementById('rev_month').value = month;
  const inMonth = state.bookings.filter(b=> b.status==='done' && b.date.startsWith(month));
  if(!inMonth.length){ document.getElementById('rev_table').innerHTML = '<div class="muted tiny">Kh√¥ng c√≥ d·ªØ li·ªáu</div>'; return; }
  const map = {};
  inMonth.forEach(b=>{
    const s = state.services.find(x=>x.id===b.serviceId); const price = s? s.price:0;
    const tech = state.techs.find(t=>t.id===b.techId);
    const key = tech? tech.id: 'unknown';
    if(!map[key]) map[key] = {name:tech?tech.name:'-', jobs:0, revenue:0, rate: tech?tech.rate: state.store.defaultCommission};
    map[key].jobs += 1; map[key].revenue += price;
  });
  const rows = Object.values(map).map(r=> ({...r, commission: Math.round(r.revenue * (r.rate/100))}) );
  let html = `<table><thead><tr><th>KTV</th><th>S·ªë ca</th><th>Doanh thu</th><th>% Hoa h·ªìng</th><th>Hoa h·ªìng</th></tr></thead><tbody>`;
  html += rows.map(r=>`<tr><td>${escapeHtml(r.name)}</td><td>${r.jobs}</td><td>${fmtMoney(r.revenue)}</td><td>${Math.round(r.rate)}%</td><td>${fmtMoney(r.commission)}</td></tr>`).join('');
  html += '</tbody></table>';
  document.getElementById('rev_table').innerHTML = html;
}

/* ---------- modal helpers ---------- */
function showModal(innerHtml){
  document.getElementById('modalInner').innerHTML = innerHtml;
  document.getElementById('modalBackdrop').style.display = 'flex';
}
function closeModal(){ document.getElementById('modalBackdrop').style.display = 'none'; }

/* ---------- CRUD: Customers ---------- */
function showAddCustomer(){
  showModal(`<h3>Th√™m kh√°ch h√†ng</h3>
    <div class="row"><div class="col"><label class="label">T√™n</label><input id="m_cust_name" class="input"></div><div style="width:160px"><label class="label">SƒêT</label><input id="m_cust_phone" class="input"></div></div>
    <div class="row"><div class="col"><label class="label">Ghi ch√∫</label><input id="m_cust_note" class="input"></div></div>
    <div style="text-align:right"><button class="btn ghost" onclick="closeModal()">H·ªßy</button> <button class="btn primary" onclick="addCustomer()">Th√™m</button></div>`);
}
function addCustomer(){
  const name = document.getElementById('m_cust_name').value.trim();
  const phone = document.getElementById('m_cust_phone').value.trim();
  const note = document.getElementById('m_cust_note').value.trim();
  if(!name || !phone) return alert('Nh·∫≠p t√™n & SƒêT');
  state.customers.push({id:uid(), name, phone, visits:0, note});
  saveState(); closeModal(); renderCustomers(); renderDashboard();
}
function editCustomer(id){
  const c = state.customers.find(x=>x.id===id);
  if(!c) return alert('Kh√¥ng t√¨m th·∫•y');
  showModal(`<h3>S·ª≠a kh√°ch</h3>
    <div class="row"><div class="col"><label class="label">T√™n</label><input id="m_cust_name" class="input" value="${escapeAttr(c.name)}"></div><div style="width:160px"><label class="label">SƒêT</label><input id="m_cust_phone" class="input" value="${escapeAttr(c.phone)}"></div></div>
    <div class="row"><div class="col"><label class="label">Ghi ch√∫</label><input id="m_cust_note" class="input" value="${escapeAttr(c.note||'')}"></div></div>
    <div style="text-align:right"><button class="btn ghost" onclick="closeModal()">H·ªßy</button> <button class="btn primary" onclick="saveEditCustomer('${c.id}')">L∆∞u</button></div>`);
}
function saveEditCustomer(id){
  const name = document.getElementById('m_cust_name').value.trim();
  const phone = document.getElementById('m_cust_phone').value.trim();
  const note = document.getElementById('m_cust_note').value.trim();
  if(!name || !phone) return alert('Nh·∫≠p t√™n & SƒêT');
  const idx = state.customers.findIndex(x=>x.id===id);
  state.customers[idx] = {...state.customers[idx], name, phone, note};
  saveState(); closeModal(); renderCustomers();
}
function deleteCustomer(id){ if(!confirm('X√≥a kh√°ch n√†y?')) return; state.customers = state.customers.filter(x=>x.id!==id); saveState(); renderCustomers(); }

/* ---------- Services ---------- */
function showAddService(){
  showModal(`<h3>Th√™m d·ªãch v·ª•</h3>
    <div class="row"><div class="col"><label class="label">T√™n d·ªãch v·ª•</label><input id="m_svc_name" class="input"></div><div style="width:140px"><label class="label">Gi√° (VND)</label><input id="m_svc_price" class="input" type="number" value="0"></div><div style="width:120px"><label class="label">Th·ªùi l∆∞·ª£ng (ph√∫t)</label><input id="m_svc_dur" class="input" type="number" value="60"></div></div>
    <div style="text-align:right"><button class="btn ghost" onclick="closeModal()">H·ªßy</button> <button class="btn primary" onclick="addService()">Th√™m</button></div>`);
}
function addService(){ const name=document.getElementById('m_svc_name').value.trim(); const price=Number(document.getElementById('m_svc_price').value)||0; const dur=Number(document.getElementById('m_svc_dur').value)||60; if(!name) return alert('Nh·∫≠p t√™n'); state.services.push({id:uid(), name, price, duration:dur}); saveState(); closeModal(); renderServices(); renderBookings(); }
function editService(id){
  const s = state.services.find(x=>x.id===id); if(!s) return;
  showModal(`<h3>S·ª≠a d·ªãch v·ª•</h3><div class="row"><div class="col"><label class="label">T√™n</label><input id="m_svc_name" class="input" value="${escapeAttr(s.name)}"></div><div style="width:140px"><label class="label">Gi√°</label><input id="m_svc_price" class="input" type="number" value="${s.price}"></div><div style="width:120px"><label class="label">Th·ªùi l∆∞·ª£ng</label><input id="m_svc_dur" class="input" type="number" value="${s.duration}"></div></div><div style="text-align:right"><button class="btn ghost" onclick="closeModal()">H·ªßy</button> <button class="btn primary" onclick="saveEditService('${s.id}')">L∆∞u</button></div>`);
}
function saveEditService(id){ const name=document.getElementById('m_svc_name').value.trim(); const price=Number(document.getElementById('m_svc_price').value)||0; const dur=Number(document.getElementById('m_svc_dur').value)||60; if(!name) return alert('Nh·∫≠p t√™n'); const idx=state.services.findIndex(x=>x.id===id); state.services[idx]={...state.services[idx], name, price, duration:dur}; saveState(); closeModal(); renderServices(); renderBookings();}
function deleteService(id){ if(!confirm('X√≥a d·ªãch v·ª•?')) return; state.services = state.services.filter(x=>x.id!==id); saveState(); renderServices(); }

/* ---------- Techs ---------- */
function showAddTech(){ showModal(`<h3>Th√™m KTV</h3><div class="row"><div class="col"><label class="label">T√™n</label><input id="m_tech_name" class="input"></div><div style="width:140px"><label class="label">Phone</label><input id="m_tech_phone" class="input"></div><div style="width:120px"><label class="label">% hoa h·ªìng</label><input id="m_tech_rate" class="input" type="number" value="${state.store.defaultCommission}"></div></div><div style="text-align:right"><button class="btn ghost" onclick="closeModal()">H·ªßy</button><button class="btn primary" onclick="addTech()">Th√™m</button></div>`); }
function addTech(){ const name=document.getElementById('m_tech_name').value.trim(); const phone=document.getElementById('m_tech_phone').value.trim(); const rate=Number(document.getElementById('m_tech_rate').value)||state.store.defaultCommission; if(!name) return alert('Nh·∫≠p t√™n'); state.techs.push({id:uid(), name, phone, rate, active:true}); saveState(); closeModal(); renderTechs(); populateTechFilter(); }
function editTech(id){ const t = state.techs.find(x=>x.id===id); if(!t) return; showModal(`<h3>S·ª≠a KTV</h3><div class="row"><div class="col"><label class="label">T√™n</label><input id="m_tech_name" class="input" value="${escapeAttr(t.name)}"></div><div style="width:140px"><label class="label">Phone</label><input id="m_tech_phone" class="input" value="${escapeAttr(t.phone)}"></div><div style="width:120px"><label class="label">% hoa h·ªìng</label><input id="m_tech_rate" class="input" type="number" value="${t.rate}"></div></div><div style="margin-bottom:6px"><label><input id="m_tech_active" type="checkbox" ${t.active? 'checked':''}/> ƒêang l√†m</label></div><div style="text-align:right"><button class="btn ghost" onclick="closeModal()">H·ªßy</button><button class="btn primary" onclick="saveEditTech('${t.id}')">L∆∞u</button></div>`); }
function saveEditTech(id){ const name=document.getElementById('m_tech_name').value.trim(); const phone=document.getElementById('m_tech_phone').value.trim(); const rate=Number(document.getElementById('m_tech_rate').value)||state.store.defaultCommission; const active=document.getElementById('m_tech_active').checked; const idx=state.techs.findIndex(x=>x.id===id); state.techs[idx]={...state.techs[idx], name, phone, rate, active}; saveState(); closeModal(); renderTechs(); populateTechFilter(); }
function deleteTech(id){ if(!confirm('X√≥a KTV?')) return; state.techs = state.techs.filter(x=>x.id!==id); saveState(); renderTechs(); populateTechFilter(); }

/* ---------- Bookings ---------- */
function showAddBooking(){
  // build selects
  const custOpts = state.customers.map(c=>`<option value="${c.id}">${escapeAttr(c.name)} ‚Äî ${escapeAttr(c.phone)}</option>`).join('') + `<option value="_new">+ Kh√°ch m·ªõi</option>`;
  const svcOpts = state.services.map(s=>`<option value="${s.id}">${escapeAttr(s.name)} ‚Äî ${fmtMoney(s.price)}</option>`).join('');
  const techOpts = state.techs.map(t=>`<option value="${t.id}">${escapeAttr(t.name)}</option>`).join('');
  showModal(`<h3>T·∫°o l·ªãch h·∫πn</h3>
    <div class="row"><div class="col"><label class="label">Kh√°ch</label><select id="m_book_cust" class="input">${custOpts}</select></div><div style="width:140px"><label class="label">Ng√†y</label><input id="m_book_date" type="date" class="input" value="${today()}"></div></div>
    <div class="row"><div class="col"><label class="label">D·ªãch v·ª•</label><select id="m_book_svc" class="input">${svcOpts}</select></div><div class="col"><label class="label">KTV</label><select id="m_book_tech" class="input">${techOpts}</select></div><div style="width:120px"><label class="label">Gi·ªù</label><input id="m_book_time" type="time" class="input" value="10:00"></div></div>
    <div class="row"><div class="col"><label class="label">S·ªë ƒëi·ªán tho·∫°i (n·∫øu kh√°ch m·ªõi)</label><input id="m_book_phone" class="input"></div><div style="width:160px"><label class="label">Tr·∫°ng th√°i</label><select id="m_book_status" class="input"><option value="scheduled">ƒê√£ ƒë·∫∑t</option><option value="inprogress">ƒêang l√†m</option><option value="done">Ho√†n th√†nh</option><option value="canceled">Hu·ª∑</option></select></div></div>
    <div style="text-align:right"><button class="btn ghost" onclick="closeModal()">H·ªßy</button><button class="btn primary" onclick="addBooking()">T·∫°o</button></div>`);
}
function addBooking(){
  const cust = document.getElementById('m_book_cust').value;
  const date = document.getElementById('m_book_date').value;
  const svcId = document.getElementById('m_book_svc').value;
  const techId = document.getElementById('m_book_tech').value;
  const time = document.getElementById('m_book_time').value;
  const phone = document.getElementById('m_book_phone').value.trim();
  const status = document.getElementById('m_book_status').value;
  if(!date || !svcId || !techId || !time) return alert('Thi·∫øu th√¥ng tin');
  let customerId = cust;
  if(cust === '_new'){
    if(!phone) return alert('Nh·∫≠p SƒêT cho kh√°ch m·ªõi'); 
    const name = prompt('T√™n kh√°ch m·ªõi:'); if(!name) return alert('H·ªßy v√¨ ch∆∞a nh·∫≠p t√™n');
    const newC = {id:uid(), name:name.trim(), phone, visits:0, note:''}; state.customers.push(newC); customerId = newC.id;
  }
  // conflict check
  const svc = state.services.find(s=>s.id===svcId); const dur = svc?svc.duration:60;
  const sMin = timeToMin(time), eMin = sMin + dur;
  const conflict = state.bookings.some(b=> b.date===date && b.techId===techId && !( (timeToMin(b.time)+ (state.services.find(x=>x.id===b.serviceId)?.duration||60)) <= sMin || eMin <= timeToMin(b.time) ) );
  if(conflict && !confirm('L·ªãch c√≥ th·ªÉ tr√πng v·ªõi ca kh√°c c·ªßa KTV. Ti·∫øp t·ª•c?')) return;
  const book = { id:uid(), date, time, serviceId:svcId, techId, customerId, customerName: state.customers.find(c=>c.id===customerId).name, phone: phone || state.customers.find(c=>c.id===customerId).phone, status, paid: status==='done', note:''};
  state.bookings.push(book);
  saveState(); closeModal(); renderBookings(); renderCustomers(); renderDashboard();
}
function editBooking(id){
  const b = state.bookings.find(x=>x.id===id); if(!b) return alert('Kh√¥ng t√¨m th·∫•y');
  // build selects with preselects
  const custOpts = state.customers.map(c=>`<option value="${c.id}" ${c.id===b.customerId?'selected':''}>${escapeAttr(c.name)} ‚Äî ${escapeAttr(c.phone)}</option>`).join('') + `<option value="_new">+ Kh√°ch m·ªõi</option>`;
  const svcOpts = state.services.map(s=>`<option value="${s.id}" ${s.id===b.serviceId?'selected':''}>${escapeAttr(s.name)} ‚Äî ${fmtMoney(s.price)}</option>`).join('');
  const techOpts = state.techs.map(t=>`<option value="${t.id}" ${t.id===b.techId?'selected':''}>${escapeAttr(t.name)}</option>`).join('');
  showModal(`<h3>S·ª≠a l·ªãch</h3>
    <div class="row"><div class="col"><label class="label">Kh√°ch</label><select id="m_book_cust">${custOpts}</select></div><div style="width:140px"><label class="label">Ng√†y</label><input id="m_book_date" type="date" class="input" value="${b.date}"></div></div>
    <div class="row"><div class="col"><label class="label">D·ªãch v·ª•</label><select id="m_book_svc">${svcOpts}</select></div><div class="col"><label class="label">KTV</label><select id="m_book_tech">${techOpts}</select></div><div style="width:120px"><label class="label">Gi·ªù</label><input id="m_book_time" type="time" class="input" value="${b.time}"></div></div>
    <div class="row"><div class="col"><label class="label">Phone</label><input id="m_book_phone" class="input" value="${escapeAttr(b.phone||'')}"></div><div style="width:160px"><label class="label">Tr·∫°ng th√°i</label><select id="m_book_status" class="input"><option value="scheduled">ƒê√£ ƒë·∫∑t</option><option value="inprogress">ƒêang l√†m</option><option value="done">Ho√†n th√†nh</option><option value="canceled">Hu·ª∑</option></select></div></div>
    <div style="text-align:right"><button class="btn ghost" onclick="closeModal()">H·ªßy</button><button class="btn primary" onclick="saveEditBooking('${b.id}')">L∆∞u</button></div>`);
  document.getElementById('m_book_status').value = b.status;
}
function saveEditBooking(id){
  const bidx = state.bookings.findIndex(x=>x.id===id); if(bidx<0) return;
  const cust = document.getElementById('m_book_cust').value;
  const date = document.getElementById('m_book_date').value;
  const svcId = document.getElementById('m_book_svc').value;
  const techId = document.getElementById('m_book_tech').value;
  const time = document.getElementById('m_book_time').value;
  const phone = document.getElementById('m_book_phone').value.trim();
  const status = document.getElementById('m_book_status').value;
  if(!date || !svcId || !techId || !time) return alert('Thi·∫øu th√¥ng tin');
  let customerId = cust;
  if(cust === '_new'){ if(!phone) return alert('Nh·∫≠p SƒêT cho kh√°ch m·ªõi'); const name=prompt('T√™n kh√°ch m·ªõi:'); if(!name) return alert('Ch∆∞a nh·∫≠p t√™n'); const newC={id:uid(),name:name.trim(),phone,visits:0,note:''}; state.customers.push(newC); customerId=newC.id; }
  const svc = state.services.find(s=>s.id===svcId); const dur = svc?svc.duration:60;
  const sMin=timeToMin(time), eMin=sMin+dur;
  const conflict = state.bookings.some(b=> b.id!==id && b.date===date && b.techId===techId && !( (timeToMin(b.time)+(state.services.find(x=>x.id===b.serviceId)?.duration||60)) <= sMin || eMin <= timeToMin(b.time) ) );
  if(conflict && !confirm('L·ªãch tr√πng ‚Äî v·∫´n l∆∞u?')) return;
  state.bookings[bidx] = {...state.bookings[bidx], date, time, serviceId:svcId, techId, customerId, customerName: state.customers.find(c=>c.id===customerId).name, phone: phone || state.customers.find(c=>c.id===customerId).phone, status, paid: status==='done'};
  saveState(); closeModal(); renderBookings(); renderCustomers();
}
function completeBooking(id){ const b = state.bookings.find(x=>x.id===id); if(!b) return; b.status='done'; b.paid=true; const cust = state.customers.find(c=>c.id===b.customerId); if(cust) cust.visits=(cust.visits||0)+1; saveState(); renderBookings(); renderDashboard(); }
function deleteBooking(id){ if(!confirm('X√≥a l·ªãch n√†y?')) return; state.bookings = state.bookings.filter(x=>x.id!==id); saveState(); renderBookings(); }

/* ---------- exports ---------- */
function exportBookings(){
  const rows = [['Ng√†y','Gi·ªù','Kh√°ch','SƒêT','D·ªãch v·ª•','KTV','Gi√°','Tr·∫°ng th√°i']];
  state.bookings.forEach(b=>{ const svc=state.services.find(s=>s.id===b.serviceId); const tech=state.techs.find(t=>t.id===b.techId); rows.push([b.date,b.time,b.customerName,b.phone,svc?svc.name:'',tech?tech.name:'',svc?svc.price:'',b.status]); });
  downloadCSV(rows,'bookings.csv');
}
function exportCustomers(){ const rows=[['T√™n','SƒêT','L·∫ßn ƒë·∫øn','Ghi ch√∫']]; state.customers.forEach(c=>rows.push([c.name,c.phone,c.visits||0,c.note||''])); downloadCSV(rows,'customers.csv'); }
function exportServices(){ const rows=[['T√™n','Gi√°','Th·ªùi l∆∞·ª£ng']]; state.services.forEach(s=>rows.push([s.name,s.price,s.duration])); downloadCSV(rows,'services.csv'); }
function exportTechs(){ const rows=[['T√™n','Phone','% hoa h·ªìng','Tr·∫°ng th√°i']]; state.techs.forEach(t=>rows.push([t.name,t.phone,t.rate,t.active?'ƒêang l√†m':'T·∫°m ngh·ªâ'])); downloadCSV(rows,'techs.csv'); }
function exportRevenue(){
  const month = document.getElementById('rev_month').value || (new Date()).toISOString().slice(0,7);
  const inMonth = state.bookings.filter(b=>b.status==='done' && b.date.startsWith(month));
  const map = {}; inMonth.forEach(b=>{ const svc=state.services.find(s=>s.id===b.serviceId); const price=svc?svc.price:0; const tech=state.techs.find(t=>t.id===b.techId); const key=tech?tech.id:'unknown'; if(!map[key]) map[key]={name:tech?tech.name:'-',jobs:0,revenue:0,rate:tech?tech.rate:state.store.defaultCommission}; map[key].jobs++; map[key].revenue+=price; });
  const rows=[['KTV','S·ªë ca','Doanh thu','%','Hoa h·ªìng']]; Object.values(map).forEach(r=>rows.push([r.name,r.jobs,r.revenue,r.rate,Math.round(r.revenue*(r.rate/100))])); downloadCSV(rows,`revenue_${month}.csv`);
}

/* ---------- settings & users ---------- */
function saveSettings(){ const name=document.getElementById('spa_name').value.trim()||'Spa Pro'; const comm=Number(document.getElementById('spa_comm').value)||32; state.store.name=name; state.store.defaultCommission=comm; saveState(); alert('L∆∞u th√†nh c√¥ng'); }
function registerUser(){ const u=document.getElementById('new_user').value.trim(); const p=document.getElementById('new_pass').value; const r=document.getElementById('new_role').value; if(!u||!p) return alert('Nh·∫≠p username & password'); if(state.users.some(x=>x.username===u)) return alert('Username ƒë√£ t·ªìn t·∫°i'); state.users.push({id:uid(), username:u, password:btoa(p), role:r, name:u}); saveState(); alert('ƒê√£ ƒëƒÉng k√Ω'); }
function resetData(){ if(!confirm('X√≥a d·ªØ li·ªáu v√† n·∫°p l·∫°i m·∫´u?')) return; localStorage.removeItem(LS_KEY); state = loadState(); location.reload(); }

/* ---------- backup/restore ---------- */
function backup(){ const blob = new Blob([JSON.stringify(state,null,2)],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=`spa_backup_${today()}.json`; a.click(); URL.revokeObjectURL(url); }
document.getElementById('fileRestore').addEventListener('change', (e)=>{ const f=e.target.files[0]; if(!f) return; const r=new FileReader(); r.onload = ()=>{ try{ const d=JSON.parse(r.result); if(!d.store) throw new Error('File kh√¥ng h·ª£p l·ªá'); if(!confirm('Ph·ª•c h·ªìi d·ªØ li·ªáu? (ghi ƒë√®)')) return; state=d; saveState(); location.reload(); }catch(err){ alert('File kh√¥ng h·ª£p l·ªá'); } }; r.readAsText(f); });

/* ---------- utilities ---------- */
function escapeHtml(s){ if(s===null||s===undefined) return ''; return String(s).replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m])); }
function escapeAttr(s){ return (s||'').replace(/"/g,'&quot;'); }
function downloadCSV(rows, filename){
  const csv = rows.map(r=> r.map(cell=> {
    if(cell===null||cell===undefined) return '';
    const s = String(cell);
    return (s.includes(',')||s.includes('"')||s.includes('\n')) ? `"${s.replace(/"/g,'""')}"` : s;
  }).join(',')).join('\n');
  const blob = new Blob(['\uFEFF'+csv], {type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=filename; a.click(); URL.revokeObjectURL(url);
}

/* ---------- quick actions for edit buttons (exposed) ---------- */
window.editCustomer = (id)=>{ editCustomer(id); };
window.editService = (id)=>{ editService(id); };
window.editTech = (id)=>{ editTech(id); };
window.editBooking = (id)=>{ editBooking(id); };

/* ---------- global search ---------- */
function doGlobalSearch(q){
  q = (q||'').toLowerCase().trim();
  if(!q){ renderAll(); return; }
  // bookings search
  const bk = state.bookings.filter(b=> (b.customerName||'').toLowerCase().includes(q) || (b.phone||'').includes(q) || (state.services.find(s=>s.id===b.serviceId)?.name||'').toLowerCase().includes(q) );
  if(bk.length) { document.getElementById('tb_bookings').innerHTML = bk.map(b=>`<tr><td>${b.date}</td><td>${b.time}</td><td>${escapeHtml(b.customerName)}</td><td>${escapeHtml(b.phone)}</td><td>${escapeHtml(state.services.find(s=>s.id===b.serviceId)?.name||'')}</td><td>${escapeHtml(state.techs.find(t=>t.id===b.techId)?.name||'')}</td><td>${fmtMoney(state.services.find(s=>s.id===b.serviceId)?.price||0)}</td><td>${escapeHtml(b.status)}</td><td><button class="btn small" onclick="editBooking('${b.id}')">S·ª≠a</button></td></tr>`).join(''); }
  // customers
  const cs = state.customers.filter(c=> (c.name||'').toLowerCase().includes(q) || (c.phone||'').includes(q));
  if(cs.length) document.getElementById('tb_customers').innerHTML = cs.map(c=>`<tr><td>${escapeHtml(c.name)}</td><td>${escapeHtml(c.phone)}</td><td>${c.visits||0}</td><td>${escapeHtml(c.note||'')}</td><td><button class="btn small" onclick="editCustomer('${c.id}')">S·ª≠a</button></td></tr>`).join('');
}

/* ---------- theme toggle ---------- */
function toggleTheme(){ document.documentElement.classList.toggle('dark'); }

/* ---------- start ---------- */
(function init(){
  // show login if no session
  if(!session){ loginView.style.display='flex'; appView.style.display='none'; } else { enterApp(); }
  // wire initial elements
  document.getElementById('spa_name').value = state.store.name || 'Spa Pro';
  document.getElementById('spa_comm').value = state.store.defaultCommission || 32;
  document.getElementById('rev_month').value = (new Date()).toISOString().slice(0,7);
  // render initial tables (data sample kept)
  renderAll();
})();
</script>
</body>
</html>
